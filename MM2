local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

repeat wait() until LocalPlayer.Character

local function createGUI()
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "NehemiasMM2GUI"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 220, 0, 160)
    frame.Position = UDim2.new(0.05, 0, 0.3, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Draggable = true
    frame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Text = "Nehemías"
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    title.TextColor3 = Color3.new(1,1,1)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.Parent = frame

    -- ESP Toggle
    local espToggle = Instance.new("TextButton")
    espToggle.Text = "ESP: OFF"
    espToggle.Size = UDim2.new(0.8, 0, 0, 30)
    espToggle.Position = UDim2.new(0.1, 0, 0, 40)
    espToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    espToggle.TextColor3 = Color3.new(1,1,1)
    espToggle.Font = Enum.Font.SourceSans
    espToggle.TextSize = 16
    espToggle.Parent = frame

    -- Tiempo de Ronda
    local tiempoToggle = Instance.new("TextButton")
    tiempoToggle.Text = "Tiempo de ronda: OFF"
    tiempoToggle.Size = UDim2.new(0.8, 0, 0, 30)
    tiempoToggle.Position = UDim2.new(0.1, 0, 0, 75)
    tiempoToggle.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    tiempoToggle.TextColor3 = Color3.new(1,1,1)
    tiempoToggle.Font = Enum.Font.SourceSans
    tiempoToggle.TextSize = 15
    tiempoToggle.Parent = frame

    -- Auto Disparo Toggle
    local autoDisparoToggle = Instance.new("TextButton")
    autoDisparoToggle.Text = "Auto Disparo: OFF"
    autoDisparoToggle.Size = UDim2.new(0.8, 0, 0, 30)
    autoDisparoToggle.Position = UDim2.new(0.1, 0, 0, 110)
    autoDisparoToggle.BackgroundColor3 = Color3.fromRGB(255, 85, 85)
    autoDisparoToggle.TextColor3 = Color3.new(1,1,1)
    autoDisparoToggle.Font = Enum.Font.SourceSans
    autoDisparoToggle.TextSize = 15
    autoDisparoToggle.Parent = frame

    return screenGui, espToggle, tiempoToggle, autoDisparoToggle
end

local function highlightPlayer(player, color)
    if player.Character then
        for _, part in pairs(player.Character:GetChildren()) do
            if part:IsA("BasePart") then
                local hl = Instance.new("BoxHandleAdornment")
                hl.Adornee = part
                hl.AlwaysOnTop = true
                hl.ZIndex = 5
                hl.Size = part.Size + Vector3.new(0.2, 0.2, 0.2)
                hl.Color3 = color
                hl.Transparency = 0.5
                hl.Name = "ESP"
                hl.Parent = part
            end
        end
    end
end

local function clearESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            for _, part in pairs(player.Character:GetChildren()) do
                if part:IsA("BasePart") then
                    local esp = part:FindFirstChild("ESP")
                    if esp then
                        esp:Destroy()
                    end
                end
            end
        end
    end
end

local function getRoles()
    local murderer, sheriff
    for _, player in pairs(Players:GetPlayers()) do
        if player.Backpack:FindFirstChild("Gun") then
            sheriff = player
        elseif player.Character and player.Character:FindFirstChild("Knife") then
            murderer = player
        end
    end
    return murderer, sheriff
end

-- 🧠 Lógica principal
local gui, espBtn, tiempoBtn, autoDisparoBtn = createGUI()
local espOn = false
local autoDisparoOn = false
local tiempoOn = false

-- ⏱ Mostrar tiempo de ronda
local tiempoLabel = Instance.new("TextLabel")
tiempoLabel.Size = UDim2.new(0, 200, 0, 30)
tiempoLabel.Position = UDim2.new(0.5, -100, 0.05, 0)
tiempoLabel.BackgroundTransparency = 1
tiempoLabel.TextColor3 = Color3.new(1, 1, 1)
tiempoLabel.Font = Enum.Font.FredokaOne
tiempoLabel.TextSize = 24
tiempoLabel.TextStrokeColor3 = Color3.new(0,0,0)
tiempoLabel.TextStrokeTransparency = 0
tiempoLabel.Parent = gui
tiempoLabel.Visible = false

local rondaActiva = false
local tiempoRonda = 0

RunService.Stepped:Connect(function(dt)
    if tiempoOn and rondaActiva then
        tiempoRonda += dt
        local mins = math.floor(tiempoRonda / 60)
        local secs = math.floor(tiempoRonda % 60)
        tiempoLabel.Text = string.format("m:%02ds:%02d", mins, secs)
    end
end)

espBtn.MouseButton1Click:Connect(function()
    espOn = not espOn
    espBtn.Text = "ESP: " .. (espOn and "ON" or "OFF")
    clearESP()
end)

tiempoBtn.MouseButton1Click:Connect(function()
    tiempoOn = not tiempoOn
    tiempoBtn.Text = "Tiempo de ronda: " .. (tiempoOn and "ON" or "OFF")
    tiempoLabel.Visible = tiempoOn
    if tiempoOn then
        tiempoRonda = 0
        rondaActiva = false
    end
end)

autoDisparoBtn.MouseButton1Click:Connect(function()
    autoDisparoOn = not autoDisparoOn
    autoDisparoBtn.Text = "Auto Disparo: " .. (autoDisparoOn and "ON" or "OFF")

    if autoDisparoOn then
        local fireBtn = Instance.new("TextButton")
        fireBtn.Text = "DISPARAR"
        fireBtn.Size = UDim2.new(0, 120, 0, 40)
        fireBtn.Position = UDim2.new(0.4, 0, 0.85, 0)
        fireBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        fireBtn.TextColor3 = Color3.new(1,1,1)
        fireBtn.Font = Enum.Font.SourceSansBold
        fireBtn.TextSize = 18
        fireBtn.Active = true
        fireBtn.Draggable = true
        fireBtn.Parent = gui

        fireBtn.MouseButton1Click:Connect(function()
            local murderer, _ = getRoles()
            local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Gun")
            if murderer and tool then
                tool:Activate()
            else
                StarterGui:SetCore("SendNotification", {
                    Title = "Nehemías",
                    Text = "Necesitas el arma",
                    Duration = 2
                })
            end
        end)
    else
        for _, obj in pairs(gui:GetChildren()) do
            if obj:IsA("TextButton") and obj.Text == "DISPARAR" then
                obj:Destroy()
            end
        end
    end
end)

-- Loop de ESP y detección de ronda
RunService.RenderStepped:Connect(function()
    if espOn then
        clearESP()
        local murderer, sheriff = getRoles()
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local color = Color3.fromRGB(0, 255, 0) -- Inocente
                if player == murderer then
                    color = Color3.fromRGB(255, 0, 0)
                elseif player == sheriff then
                    color = Color3.fromRGB(0, 0, 255)
                end
                highlightPlayer(player, color)
            end
        end
    end

    -- Detectar inicio de ronda
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local posY = LocalPlayer.Character.HumanoidRootPart.Position.Y
        if posY > 10 and not rondaActiva then
            rondaActiva = true
            tiempoRonda = 0
        elseif posY < 10 and rondaActiva then
            rondaActiva = false
            tiempoRonda = 0
            clearESP()
        end
    end
end)
