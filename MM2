local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

repeat wait() until LocalPlayer.Character

-- Crear GUI
local playerGui = LocalPlayer:WaitForChild("PlayerGui")
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NehemiasMM2"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 260, 0, 200)
frame.Position = UDim2.new(0.05, 0, 0.2, 0)
frame.BackgroundColor3 = Color3.fromRGB(35,35,35)
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,30)
title.Text = "Nehemías"
title.Font = Enum.Font.Freedoka
title.TextSize = 20
title.BackgroundColor3 = Color3.fromRGB(60,60,60)
title.TextColor3 = Color3.new(1,1,1)

local espBtn = Instance.new("TextButton", frame)
espBtn.Size = UDim2.new(0.9,0,0,30)
espBtn.Position = UDim2.new(0.05,0,0,40)
espBtn.Text = "ESP: OFF"
espBtn.Font = Enum.Font.Freedoka
espBtn.TextSize = 16
espBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
espBtn.TextColor3 = Color3.new(1,1,1)

local timeBtn = Instance.new("TextButton", frame)
timeBtn.Size = UDim2.new(0.9,0,0,30)
timeBtn.Position = UDim2.new(0.05,0,0,80)
timeBtn.Text = "Tiempo de ronda: OFF"
timeBtn.Font = Enum.Font.Freedoka
timeBtn.TextSize = 16
timeBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
timeBtn.TextColor3 = Color3.new(1,1,1)

local autoBtn = Instance.new("TextButton", frame)
autoBtn.Size = UDim2.new(0.9,0,0,30)
autoBtn.Position = UDim2.new(0.05,0,0,120)
autoBtn.Text = "Auto Disparo: OFF"
autoBtn.Font = Enum.Font.Freedoka
autoBtn.TextSize = 16
autoBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
autoBtn.TextColor3 = Color3.new(1,1,1)

local minimize = Instance.new("TextButton", frame)
minimize.Size = UDim2.new(0,20,0,20)
minimize.Position = UDim2.new(1,-25,0,5)
minimize.Text = "-"
minimize.Font = Enum.Font.Freedoka
minimize.TextSize = 18
minimize.BackgroundColor3 = Color3.fromRGB(255,80,80)
minimize.TextColor3 = Color3.new(1,1,1)

-- Tiempo de ronda (arriba pantalla)
local timeLabel = Instance.new("TextLabel", screenGui)
timeLabel.Size = UDim2.new(0,160,0,40)
timeLabel.Position = UDim2.new(0.5,-80,0.05,0)
timeLabel.BackgroundTransparency = 1
timeLabel.Font = Enum.Font.Freedoka
timeLabel.TextSize = 28
timeLabel.TextColor3 = Color3.new(1,1,1)
timeLabel.TextStrokeColor3 = Color3.new(0,0,0)
timeLabel.TextStrokeTransparency = 0
timeLabel.Visible = false

-- Botón flotante de disparo
local shootBtn = Instance.new("TextButton", screenGui)
shootBtn.Size = UDim2.new(0,110,0,40)
shootBtn.Position = UDim2.new(0.5,-55,0.7,0)
shootBtn.Text = "Disparar"
shootBtn.Font = Enum.Font.Freedoka
shootBtn.TextSize = 18
shootBtn.BackgroundColor3 = Color3.fromRGB(0,120,255)
shootBtn.TextColor3 = Color3.new(1,1,1)
shootBtn.Visible = false
shootBtn.Active = true
shootBtn.Draggable = true

-- Variables internas
local espOn, timeOn, autoOn = false, false, false
local espTrack = {}
local roundStart = 0
local roundDuration = 150 -- ajustar si cambia el tiempo real de ronda
local inRound = false

-- Obtener roles
local function getRoles()
	local murderer, sheriff = nil, nil
	for _,plr in pairs(Players:GetPlayers()) do
		local bp = plr:FindFirstChildOfClass("Backpack")
		if bp then
			if bp:FindFirstChild("Knife") then murderer = plr end
			if bp:FindFirstChild("Gun") then sheriff = plr end
		end
		if plr.Character then
			if plr.Character:FindFirstChild("Knife") then murderer = plr end
			if plr.Character:FindFirstChild("Gun") then sheriff = plr end
		end
	end
	return murderer, sheriff
end

-- Colores por rol
local function roleColor(plr)
	if not inRound then return Color3.fromRGB(0,255,0) end
	local m, s = getRoles()
	if plr == m then return Color3.fromRGB(255,0,0) end
	if plr == s then return Color3.fromRGB(0,0,255) end
	return Color3.fromRGB(0,255,0)
end

-- Limpiar ESP
local function clearESP()
	for _,obj in pairs(espTrack) do
		if obj and obj.Parent then
			obj:Destroy()
		end
	end
	table.clear(espTrack)
end

-- ESP: resaltar cuerpo + nombre
local function updateESP()
	clearESP()
	for _,plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local clr = roleColor(plr)
			local bi = Instance.new("BillboardGui", plr.Character)
			bi.Size = UDim2.new(0,100,0,40)
			bi.Adornee = plr.Character:FindFirstChild("Head")
			bi.AlwaysOnTop = true
			local lbl = Instance.new("TextLabel", bi)
			lbl.Size = UDim2.new(1,1)
			lbl.BackgroundTransparency = 1
			lbl.Text = plr.Name
			lbl.TextColor3 = clr
			lbl.Font = Enum.Font.Freedoka
			lbl.TextScaled = true
			table.insert(espTrack, bi)

			for _,part in pairs(plr.Character:GetChildren()) do
				if part:IsA("BasePart") then
					local box = Instance.new("BoxHandleAdornment", part)
					box.Adornee = part
					box.AlwaysOnTop = true
					box.ZIndex = 5
					box.Size = part.Size + Vector3.new(0.05,0.05,0.05)
					box.Transparency = 0.5
					box.Color3 = clr
					table.insert(espTrack, box)
				end
			end
		end
	end
end

-- Control de tiempo de ronda
RunService.RenderStepped:Connect(function()
	if inRound and timeOn then
		local now = os.time()
		local elapsed = now - roundStart
		local remaining = math.max(0, roundDuration - elapsed)
		local m = math.floor(remaining / 60)
		local s = remaining % 60
		timeLabel.Text = string.format("%d:%02d", m, s)
		if remaining <= 0 then
			timeLabel.Visible = false
		else
			timeLabel.Visible = true
		end
	end
end)

-- Detectar inicio/fin de ronda vía objeto Map
workspace.ChildAdded:Connect(function(c)
	if c.Name == "Map" then
		wait(1)
		roundStart = os.time()
		inRound = true
		if timeOn then timeLabel.Visible = true end
		if espOn then updateESP() end
	end
end)
workspace.ChildRemoved:Connect(function(c)
	if c.Name == "Map" then
		inRound = false
		timeLabel.Visible = false
		clearESP()
	end
end)

-- Actualizar ESP al cambiar jugadores o roles
Players.PlayerAdded:Connect(function()
	if espOn and inRound then updateESP() end
end)
Players.PlayerRemoving:Connect(function()
	if espOn and inRound then updateESP() end
end)

-- Toggle ESP
espBtn.MouseButton1Click:Connect(function()
	espOn = not espOn
	espBtn.Text = "ESP: " .. (espOn and "ON" or "OFF")
	espBtn.BackgroundColor3 = espOn and Color3.fromRGB(0,170,0) or Color3.fromRGB(100,100,100)
	if espOn and inRound then updateESP() else clearESP() end
end)

-- Toggle Tiempo de ronda
timeBtn.MouseButton1Click:Connect(function()
	timeOn = not timeOn
	timeBtn.Text = "Tiempo de ronda: " .. (timeOn and "ON" or "OFF")
	timeBtn.BackgroundColor3 = timeOn and Color3.fromRGB(0,170,0) or Color3.fromRGB(100,100,100)
	if timeOn and inRound then
		timeLabel.Visible = true
	else
		timeLabel.Visible = false
	end
end)

-- Toggle Auto Disparo
autoBtn.MouseButton1Click:Connect(function()
	autoOn = not autoOn
	autoBtn.Text = "Auto Disparo: " .. (autoOn and "ON" or "OFF")
	autoBtn.BackgroundColor3 = autoOn and Color3.fromRGB(0,170,0) or Color3.fromRGB(100,100,100)
	shootBtn.Visible = autoOn
end)

-- Función disparar directo al Murderer
shootBtn.MouseButton1Click:Connect(function()
	local murderer, sheriff = getRoles()
	if not murderer or not sheriff then
		StarterGui:SetCore("SendNotification", {Title="Nehemías"; Text="No se detectó murderer o sheriff"; Duration=2})
		return
	end
	if LocalPlayer ~= sheriff then
		StarterGui:SetCore("SendNotification", {Title="Nehemías"; Text="Solo el sheriff puede disparar"; Duration=2})
		return
	end
	local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Gun")
	if not tool then
		StarterGui:SetCore("SendNotification", {Title="Nehemías"; Text="Necesitás el arma"; Duration=2})
		return
	end
	-- Activar el disparo
	tool:Activate()
	-- Disparar hacia la posición del Murderer
	local ev = ReplicatedStorage:FindFirstChild("ShootEvent")
	if ev and murderer.Character and murderer.Character:FindFirstChild("HumanoidRootPart") then
		ev:FireServer(murderer.Character.HumanoidRootPart.Position)
	end
end)

-- Minimizar GUI
minimize.MouseButton1Click:Connect(function()
	local isMinimized = frame.Size.Y.Offset == 200
	if isMinimized then
		for _,child in pairs(frame:GetChildren()) do
			if child ~= title and child ~= minimize then
				child.Visible = false
			end
		end
		frame.Size = UDim2.new(0, 260, 0, 35)
		minimize.Text = "+"
	else
		for _,child in pairs(frame:GetChildren()) do
			child.Visible = true
		end
		frame.Size = UDim2.new(0, 260, 0, 200)
		minimize.Text = "-"
	end
end)
